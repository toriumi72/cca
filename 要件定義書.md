# 家計簿管理アプリ ─ 詳細要件定義（Markdown 版）

---

## 0. 前提

* **シングルユーザー利用**を想定（将来的には LINE ユーザー ID との連携可）。
* **オフライン PWA** として動作し、後から LIFF／クラウド同期を追加可能なアーキテクチャ。
* **全データはローカルストレージ**（IndexedDB／Local Storage）に永続化。
* 金額単位は円（整数）を基本とし、将来的に通貨切替に対応できる設計。
* **カテゴリは初期状態では 0 件**。初回起動時に「サンプルを生成」or「自分で作成」ダイアログを表示。

---

## 1. 支出管理機能

### 1.1 登録（Create）

* **入力項目**

  * 必須: `金額（正数・1〜9,999,999 円）`, `日付（YYYY-MM-DD）`, `カテゴリ（プルダウン／最近使用順）`
  * 任意: `メモ（最大 200 文字）`, `レシート画像添付（1 枚）`
* **入力バリデーション**

  * 数値以外・負数はエラー。
  * 未来日付は警告ダイアログで確認。
* **補助機能**

  * **自動日付補完**: 入力フォームを開いた日の日時を初期値。
  * **金額テンキー**: モバイル最適化（`inputmode="numeric"`）。
  * **カテゴリショートカット**: 直近 3 件をワンタップで選択。
  * **レシート OCR 取り込み**（後日実装）の API フックを用意。

### 1.2 一覧・詳細閲覧（Read）

* **並び替え**

  * デフォルト: `日付降順`。
  * オプション: `カテゴリ`, `金額`, `登録日時`。
* **フィルタ**

  * **期間**: 当月 / 先月 / 今年 / カスタム範囲。
  * **カテゴリ複数選択**（AND／OR 両対応）。
  * **金額範囲**: 最小値〜最大値スライダー。
  * **キーワード検索**: メモ全文検索。
* **ページネーション**

  * 仮想スクロールで 50 件単位の遅延レンダリング。

### 1.3 編集・削除（Update / Delete）

* **編集画面**

  * 登録フォームと共通 UI。
  * 変更前後の差分ハイライト（カテゴリ・金額）。
* **削除**

  * スワイプ or 長押しメニュー → “削除” → 確認ダイアログ。
  * **ゴミ箱機能**: 削除データは 30 日間保持し復元可。

### 1.4 追加機能（必須ではないが実装余地）

* **定期支出テンプレート**（家賃・サブスク）
* **分割支出**（一回の支払いを複数カテゴリへ配賦）
* **タグ付け**（旅行・イベントなど横断的ラベリング）

---

## 2. 収入管理機能

### 2.1 登録

* **入力項目**

  * `金額`, `日付`, `収入源（給与／副業／その他 + 自由入力）`, `メモ`
* **定期収入テンプレート**

  * 月次給与・年 2 回賞与などの自動生成ルールを保存。

### 2.2 一覧・編集・削除

* 支出と同一 UI コンポーネントを再利用。
* 収入行はプラス表示・色分け（例: グリーン）。

---

## 3. カテゴリ管理機能（ユーザー完全自由）

### 3.1 CRUD

* **作成**

  * `カテゴリ名（必須・20 文字以内）`, `アイコン`, `色`, `タイプ（支出/収入/両方）`
  * 名前重複チェック（大小文字・全半角を区別しない）。
* **編集**

  * 変更履歴ログ保持（レポート集計の整合性確保）。
* **削除**

  * 使用履歴がある場合

    * **マージ先カテゴリ選択** or **「未分類」へ移送** を要求。
* **並び順**

  * ドラッグ&ドロップで並び替え、並び順は全フォームに即時反映。

### 3.2 予算設定

* 各カテゴリごとに **月次予算（0〜9,999,999 円）** を設定。
* 予算更新は翌月から適用／即時適用を選択可能。
* 予算なしは “制限なし” として扱う。

---

## 4. 分析・レポート機能

### 4.1 月次サマリー

* **収支合計**, **カテゴリ別支出額 Top5**, **前月比%**, **前年同月比%**。
* ダッシュボードにカード UI で表示。

### 4.2 グラフ

* **折れ線グラフ**: 月別支出推移（過去 12 ヶ月 + 今年予算）
* **円グラフ**: 当月カテゴリ別比率（支出のみ / 収支合算 切替ボタン）
* **棒グラフ**: 予算対実績（カテゴリ別）
* グラフライブラリは `chart.js` を想定、色はカテゴリ設定に追従。

### 4.3 予算アラート

* 支出登録時に **カテゴリ予算残額 < 0** なら赤字警告トースト。
* 月次残予算はダッシュボードにプログレスバーで表示（緑→黄→赤）。
* **全体予算**（任意）は総合収支バーで管理。

---

## 5. データ管理機能

### 5.1 永続化

* **IndexedDB** にスキーマバージョンを保持。
* マイグレーションレイヤで将来の構造変更に対応。
* **Undo/Redo** 用のイベントログを最大 500 件保持。

### 5.2 エクスポート / インポート

* **CSV**

  * 支出・収入・カテゴリ・予算を個別 or 一括出力。
  * 区切り文字`,`、文字コード UTF-8、ヘッダ行あり。
* **JSON バックアップ**

  * 全レコード + スキーマバージョン + 作成日時。
  * インポート時はプレビュー & データ上書き / 追加入力を選択。

### 5.3 自動バックアップ（オプション）

* PWA の `beforeunload` で差分を `localStorage` にスナップショット。
* **手動バックアップ** ボタンも提供。

---

## 6. アプリ設定

* **通貨**（円, USD, EUR…）
* **開始曜日**（日曜 / 月曜）
* **テーマ**（ライト / ダーク / システム依存）
* **パスコード / 生体認証ロック**
* **デバッグログ送信**（開発時のみ）

---

## 7. 非機能要件

### 7.1 パフォーマンス

* 初期ロード < 1.0 秒（Lighthouse モバイル計測）。
* 1000 件データでリスト操作 60 fps を維持。

### 7.2 セキュリティ

* IndexedDB への保存前に **AES-256 で暗号化**（パスコード鍵）。
* 画像は Service Worker cache で Blob URL 化し第三者閲覧不可に。

### 7.3 アクセシビリティ

* WCAG 2.1 AA 準拠（コントラスト比, フォーカスインジケータ）。
* スクリーンリーダラベル完備・動的領域は `aria-live` 対応。

### 7.4 国際化（i18n）

* 日本語 / 英語リソースファイル分離。
* 日付・数字フォーマットは `Intl` API を使用。

### 7.5 テスト

* **ユニットテスト**: 入力検証・計算ロジック（Jest）。
* **E2E テスト**: 主要フロー（Playwright）。
* **パフォーマンステスト**: ストレスシナリオ 5,000 件で測定。

---

## 8. 将来的拡張ポイント

1. **LINE 連携**

   * Webhook → レシート画像受信 → OCR → JSON → アプリへ push。
   * LINE Login でユーザー ID とローカルデータ紐付け。
2. **クラウド同期**

   * Supabase/PostgreSQL + Row Level Security でマルチデバイス同期。
3. **AI レコメンド**

   * 過去データから月次予算提案、節約アドバイスをチャット形式で提示。
4. **金融 API 連携**

   * 銀行明細自動取込（Moneytree, Plaid 等）。

---
